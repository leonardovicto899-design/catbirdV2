<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Gato Bird - Vers√£o Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            touch-action: none;
            background-color: #1a1a1a;
            user-select: none;
            margin: 0; padding: 0;
            position: fixed; 
            width: 100%;
            height: 100%;
        }

        #game-container {
            position: relative;
            width: 100vw; 
            height: 100vh;
            height: 100dvh;
            background: linear-gradient(180deg, #63a4ff 0%, #83eaf1 100%);
            overflow: hidden;
        }

        canvas { display: block; z-index: 1; width: 100%; height: 100%; }

        .ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            padding: 20px; 
            box-sizing: border-box;
        }
        
        .interactive { pointer-events: auto !important; }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255,255,255,0.5);
            max-height: 85dvh; 
            display: flex;
            flex-direction: column;
            animation: floatIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes floatIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .btn {
            color: white;
            padding: 12px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.1s;
            border-bottom: 5px solid rgba(0,0,0,0.2);
            width: 100%;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .btn:active { transform: translateY(4px); border-bottom-width: 2px; }
        
        .skin-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px;
            padding: 5px;
        }
        
        .skin-item {
            aspect-ratio: 1;
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            background: #fff;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
            overflow: hidden;
        }
        .skin-item img { width: 100%; height: 100%; object-fit: cover; }
        .skin-item.locked { opacity: 0.4; filter: grayscale(1); background: #ddd; }
        .skin-item:active { transform: scale(0.9); }
        .skin-item.selected { border-color: #F59E0B; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3); z-index: 10; transform: scale(1.05); }
        
        .count-badge {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: #EF4444;
            color: white;
            font-size: 10px;
            font-weight: 900;
            padding: 1px 5px;
            border-radius: 10px;
            border: 1px solid white;
            z-index: 5;
        }

        .hidden { display: none !important; }
        
        .daily-timer { font-size: 0.7rem; background: #000; color: #10B981; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        
        .leaderboard-row { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .leaderboard-row:hover { background: #f9fafb; }
        .leaderboard-row:active { background: #eff6ff; }
        .leaderboard-row:last-child { border-bottom: none; }
        
        .friend-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f3f4f6; border-radius: 10px; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        
        .news-item { text-align: left; background: #f3f4f6; padding: 10px; border-radius: 12px; margin-bottom: 8px; border-left: 4px solid #F59E0B; }
        .news-date { font-size: 0.7rem; color: #9ca3af; font-weight: bold; }
        .news-title { font-weight: 800; color: #374151; font-size: 1rem; }
        .news-body { font-size: 0.85rem; color: #4b5563; margin-top: 4px; line-height: 1.2; }
        
        .notif-item { text-align: left; background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 10px; margin-bottom: 5px; }
        
        .market-item {
            background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }

        #muteBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px; height: 40px;
            background: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 50;
            cursor: pointer;
            border: 2px solid #eee;
        }
        #muteBtn:active { transform: scale(0.9); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #bbb; }
        
        #versionLabel {
            position: absolute;
            bottom: 5px;
            right: 10px;
            color: rgba(255,255,255,0.5);
            font-size: 10px;
            font-weight: bold;
            z-index: 5;
        }

        .online-dot { width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px #22c55e; }
        .offline-dot { width: 8px; height: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc, collection, query, orderBy, limit, getDocs, where, runTransaction, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAh1Xzb616gPPnnmrjTJSGKp1zwosuVO7w",
            authDomain: "cat-bird.firebaseapp.com",
            projectId: "cat-bird",
            storageBucket: "cat-bird.firebasestorage.app",
            messagingSenderId: "1050244688440",
            appId: "1:1050244688440:web:168777901fb3ebb1c454cd"
        };
        
        // Inicializa√ß√£o Segura do Firebase
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.firebaseDb = db;
            window.firebaseAuth = auth;
            console.log("Firebase conectado.");
        } catch (e) {
            console.error("Erro ao conectar Firebase:", e);
        }

        const auth = window.firebaseAuth;
        const db = window.firebaseDb;

        // Atualizador de Presen√ßa
        setInterval(() => {
            if(auth && auth.currentUser) {
                updateDoc(doc(db, "users", auth.currentUser.uid), { lastActive: Date.now() }).catch(e => {});
            }
        }, 60000);

        window.authSystem = {
            user: null,
            login: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                const msg = document.getElementById('authMsg');
                try {
                    msg.innerText = "Carregando...";
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (error) { msg.innerText = "Erro: " + error.message; }
            },
            register: async () => {
                const email = document.getElementById('emailInput').value;
                const pass = document.getElementById('passInput').value;
                const msg = document.getElementById('authMsg');
                if(pass.length < 6) return msg.innerText = "Senha deve ter 6+ d√≠gitos";
                try {
                    msg.innerText = "Criando...";
                    await createUserWithEmailAndPassword(auth, email, pass);
                } catch (error) { msg.innerText = "Erro: " + error.message; }
            },
            saveName: async () => {
                const nameInp = document.getElementById('nameInput');
                const msg = document.getElementById('nameMsg');
                const name = nameInp.value.trim().toUpperCase(); 
                
                if(name.length < 3 || name.length > 10) return msg.innerText = "Nome deve ter 3-10 letras";
                msg.innerText = "Verificando disponibilidade...";
                
                try {
                    const q = query(collection(db, "users"), where("displayName", "==", name));
                    const querySnapshot = await getDocs(q);
                    
                    if(!querySnapshot.empty) {
                        return msg.innerText = "Nome j√° existe! Tente outro.";
                    }
                    
                    const user = auth.currentUser;
                    await updateProfile(user, { displayName: name });
                    await setDoc(doc(db, "users", user.uid), { 
                        displayName: name, 
                        lastActive: Date.now(),
                        highScore: 0
                    }, { merge: true });
                    document.getElementById('nameSetupScreen').classList.add('hidden');
                    window.location.reload();
                } catch(e) {
                    console.error(e);
                    msg.innerText = "Erro ao salvar: " + e.message;
                }
            },
            logout: async () => {
                await signOut(auth);
                window.location.reload();
            },
            playOffline: () => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('nameSetupScreen').classList.add('hidden'); 
                if(window.gameLoadLocal) window.gameLoadLocal();
            },
            saveData: async (data) => {
                if(!window.authSystem.user) return;
                try { await setDoc(doc(db, "users", window.authSystem.user.uid), data, { merge: true }); } 
                catch(e) { console.error("Erro nuvem:", e); }
            }
        };

        // ESCUTA AUTENTICA√á√ÉO
        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    window.authSystem.user = user;
                    const msg = document.getElementById('authMsg');
                    if(msg) msg.innerText = "Sucesso!";
                    
                    if(!user.displayName) {
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('nameSetupScreen').classList.remove('hidden');
                        return; 
                    }

                    const logoutBtn = document.getElementById('logoutBtn');
                    if(logoutBtn) logoutBtn.classList.remove('hidden');
                    
                    const docRef = doc(db, "users", user.uid);
                    try {
                        const docSnap = await getDoc(docRef);
                        await updateDoc(docRef, { lastActive: Date.now() }).catch(()=>{});

                        if (docSnap.exists() && window.gameSetState) {
                            window.gameSetState(docSnap.data());
                        } else if(window.gameGetState) {
                            window.authSystem.saveData(window.gameGetState());
                        }
                    } catch(e) {
                        console.error("Erro ao carregar dados:", e);
                    }
                    
                    window.startNotificationListener();
                    document.getElementById('loginScreen').classList.add('hidden');
                }
            });
        }

        // --- FUN√á√ïES DE AMIGOS E RANKING ---
        window.searchFriend = async () => {
            if(!auth.currentUser) return alert("Fa√ßa login primeiro!");
            const input = document.getElementById('friendSearchInput');
            const msg = document.getElementById('friendMsg');
            const name = input.value.trim().toUpperCase();
            
            if(name.length < 3) return;
            msg.innerText = "Buscando...";
            try {
                const q = query(collection(db, "users"), where("displayName", "==", name));
                const snap = await getDocs(q);
                
                if(snap.empty) {
                    msg.innerText = "Jogador n√£o encontrado.";
                } else {
                    let found = false;
                    snap.forEach(async (d) => {
                         if(d.id !== auth.currentUser.uid) {
                             try {
                                 await addDoc(collection(db, "notifications"), {
                                     from: auth.currentUser.uid,
                                     fromName: auth.currentUser.displayName,
                                     to: d.id,
                                     type: 'friend_request',
                                     date: Date.now()
                                 });
                                 msg.innerText = `Enviado para ${d.data().displayName}!`;
                                 msg.style.color = '#10B981';
                                 input.value = "";
                                 found = true;
                             } catch(err) {
                                 msg.innerText = "Erro ao enviar.";
                             }
                         }
                    });
                    if(!found) msg.innerText = "Voc√™ n√£o pode se adicionar.";
                }
            } catch(e) {
                console.error(e);
                msg.innerText = "Erro ao buscar.";
            }
        };

        window.loadFirebaseLeaderboard = async () => {
            const list = document.getElementById('leaderboardList');
            if(!list) return;
            list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm"><i class="fas fa-spinner fa-spin"></i> Carregando Top 10...</div>';
            try {
                const q = query(collection(db, "users"), orderBy("highScore", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                list.innerHTML = '';
                
                if (querySnapshot.empty) {
                    list.innerHTML = '<div class="p-4 text-center text-gray-400">Sem jogadores ainda.</div>';
                    return;
                }

                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let displayName = data.displayName || "An√¥nimo";
                    const isMe = auth.currentUser && auth.currentUser.uid === doc.id;
                    
                    const row = document.createElement('div');
                    row.className = 'leaderboard-row';
                    if (rank === 1) row.style.color = '#F59E0B';
                    else if (rank === 2) row.style.color = '#9CA3AF';
                    else if (rank === 3) row.style.color = '#B45309';
                    
                    row.innerHTML = `
                        <span>#${rank} ${displayName} ${isMe ? '(Eu)' : ''}</span>
                        <span>${data.highScore || 0}</span>
                    `;
                    
                    if(!isMe) {
                        row.onclick = () => {
                            if(confirm(`Adicionar ${displayName} aos amigos?`)) {
                                document.getElementById('friendSearchInput').value = displayName;
                                window.searchFriend();
                            }
                        };
                    }
                    
                    list.appendChild(row);
                    rank++;
                });
            } catch (error) {
                console.error("Erro Rank:", error);
                list.innerHTML = '<div class="p-4 text-center text-red-400 text-sm">Erro ao carregar ranking.</div>';
            }
        };

        // NOTIFICA√á√ïES EM TEMPO REAL
        window.startNotificationListener = () => {
            if(!auth.currentUser) return;
            const notifList = document.getElementById('notifList');
            
            try {
                const q = query(collection(db, "notifications"), where("to", "==", auth.currentUser.uid));
                onSnapshot(q, (snapshot) => {
                    notifList.innerHTML = '';
                    let validCount = 0;
                    
                    if(snapshot.empty) {
                        document.getElementById('notifBadge').classList.add('hidden');
                        notifList.innerHTML = '<div class="text-gray-400 text-sm text-center">Sem notifica√ß√µes novas.</div>';
                        return;
                    }

                    snapshot.forEach(docSnap => {
                        const notif = docSnap.data();
                        validCount++;
                        
                        const el = document.createElement('div');
                        el.className = 'notif-item';
                        
                        if(notif.type === 'friend_request') {
                            el.innerHTML = `
                                <div class="font-bold text-sm mb-1"><i class="fas fa-user-plus text-blue-500"></i> Pedido de Amizade</div>
                                <div class="text-xs text-gray-600 mb-2">${notif.fromName} quer ser seu amigo.</div>
                                <div class="flex gap-2">
                                    <button class="btn bg-green-500 py-1 text-xs mb-0" id="accept-${docSnap.id}">Aceitar</button>
                                    <button class="btn bg-red-500 py-1 text-xs mb-0" id="deny-${docSnap.id}">Recusar</button>
                                </div>
                            `;
                        }
                        
                        notifList.appendChild(el);
                        
                        setTimeout(() => {
                            const denyBtn = document.getElementById(`deny-${docSnap.id}`);
                            if(denyBtn) {
                                denyBtn.onclick = async () => {
                                    await deleteDoc(doc(db, "notifications", docSnap.id));
                                };
                            }
                            
                            const accFriendBtn = document.getElementById(`accept-${docSnap.id}`);
                            if(accFriendBtn) {
                                accFriendBtn.onclick = async () => {
                                    try {
                                        await game.acceptFriend(notif.from, notif.fromName);
                                        await deleteDoc(doc(db, "notifications", docSnap.id));
                                    } catch(e) {
                                        console.error("Erro ao aceitar:", e);
                                        alert("Erro ao aceitar amigo. Tente novamente.");
                                    }
                                };
                            }
                        }, 50);
                    });

                    const badge = document.getElementById('notifBadge');
                    if(validCount > 0) {
                        badge.classList.remove('hidden');
                        badge.innerText = validCount;
                    } else {
                        badge.classList.add('hidden');
                    }
                });
            } catch(e) {
                console.error("Erro listener notif:", e);
            }
        };

        window.syncServerShop = async () => {
            try {
                const shopRef = doc(db, "server", "dailyShop");
                const snap = await getDoc(shopRef);
                const now = Date.now();
                let shopData = null;
                if (snap.exists()) shopData = snap.data();
                if (!shopData || now > shopData.expires) {
                    if(window.GAME_CATS) {
                        const pool = window.GAME_CATS.filter(c => ['comum','raro','epico','legendario'].includes(c.raridade) && c.aparecer_na_loja !== false);
                        const selected = [];
                        if (pool.length > 0) {
                            for(let i=0; i<3; i++) selected.push(pool[Math.floor(Math.random() * pool.length)].id);
                        }
                        shopData = { items: selected, expires: now + 86400000 };
                        await setDoc(shopRef, shopData);
                    }
                }
                if (window.updateShopFromData) window.updateShopFromData(shopData);
            } catch (e) {
                if (window.updateShopFromData) window.updateShopFromData(null);
            }
        };
    </script>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="versionLabel">v3.0 Final & Fix</div>
        
        <div id="muteBtn" class="interactive" onclick="game.toggleMute()">
            <i class="fas fa-volume-up" id="muteIcon"></i>
        </div>

        <div id="nameSetupScreen" class="ui-layer interactive z-50 hidden">
            <div class="card">
                <h1 class="text-3xl font-black text-orange-500 mb-2">QUEM √â VOC√ä?</h1>
                <p class="text-sm text-gray-400 mb-6 font-bold">Escolha um nome √∫nico para o Rank</p>
                <input type="text" id="nameInput" placeholder="Seu Nome" maxlength="10" class="w-full bg-gray-100 p-3 rounded-xl mb-3 border-2 border-gray-200 font-bold text-gray-700 outline-none focus:border-orange-400 text-center uppercase">
                <button class="btn bg-orange-500 mb-2" onclick="authSystem.saveName()">CONFIRMAR NOME</button>
                <div id="nameMsg" class="mt-4 text-xs font-black text-red-500 h-4"></div>
            </div>
        </div>

        <div id="loginScreen" class="ui-layer interactive z-50">
            <div class="card">
                <h1 class="text-4xl font-black text-orange-500 mb-2">GATO BIRD</h1>
                <p class="text-sm text-gray-400 mb-6 font-bold">SALVAR PROGRESSO NA NUVEM</p>

                <input type="email" id="emailInput" placeholder="Seu E-mail" class="w-full bg-gray-100 p-3 rounded-xl mb-3 border-2 border-gray-200 font-bold text-gray-700 outline-none focus:border-orange-400">
                <input type="password" id="passInput" placeholder="Sua Senha" class="w-full bg-gray-100 p-3 rounded-xl mb-6 border-2 border-gray-200 font-bold text-gray-700 outline-none focus:border-orange-400">

                <button class="btn bg-green-500 mb-2" onclick="authSystem.login()"><i class="fas fa-sign-in-alt mr-2"></i> ENTRAR</button>
                <button class="btn bg-blue-500 mb-4" onclick="authSystem.register()"><i class="fas fa-user-plus mr-2"></i> CRIAR CONTA</button>
                <button class="text-xs text-gray-400 font-bold hover:text-orange-500" onclick="authSystem.playOffline()">JOGAR SEM SALVAR (OFFLINE)</button>
                
                <div id="authMsg" class="mt-4 text-xs font-black text-red-500 h-4"></div>
            </div>
        </div>

        <div id="hud" class="absolute top-0 w-full p-4 flex justify-between items-start pointer-events-none z-10">
            <div class="flex flex-col gap-2">
                <div class="bg-white/20 backdrop-blur-md text-white px-5 py-2 rounded-full font-black border-2 border-white/50 shadow-lg flex items-center gap-2 text-xl">
                    <i class="fas fa-coins text-yellow-300 drop-shadow-md"></i> <span id="coinCountHud">0</span>
                </div>
                <div id="tournamentHud" class="hidden bg-purple-600/80 backdrop-blur-md text-white px-3 py-1 rounded-full font-bold text-xs border border-white/30 shadow-lg">
                    üèÜ TORNEIO ATIVO
                </div>
            </div>
            <div id="scoreDisplay" class="text-7xl font-black text-white drop-shadow-lg" style="-webkit-text-stroke: 3px rgba(0,0,0,0.2);">0</div>
        </div>

        <div id="menuScreen" class="ui-layer interactive">
            <div class="card">
                <div class="relative w-full">
                    <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-2">GATO BIRD</h1>
                    <div class="absolute top-0 right-0">
                         <button onclick="game.openUI('notifications')" class="relative text-gray-400 hover:text-orange-500 text-xl p-2">
                             <i class="fas fa-bell"></i>
                             <span id="notifBadge" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[8px] font-bold px-1 rounded-full">0</span>
                         </button>
                    </div>
                     <div class="absolute top-0 left-0">
                          <button onclick="game.openUI('codes')" class="relative text-gray-400 hover:text-green-500 text-xl p-2">
                             <i class="fas fa-gift"></i>
                         </button>
                    </div>
                </div>
                
                <div class="bg-blue-50 rounded-3xl p-6 border-4 border-white shadow-inner mb-4 flex flex-col items-center relative">
                    <div class="relative w-24 h-24 mb-2 bg-white rounded-2xl shadow-sm overflow-hidden flex items-center justify-center">
                        <canvas id="menuPreview" width="100" height="100" class="w-full h-full object-contain"></canvas>
                    </div>
                
                    <div id="displayName" class="font-black text-2xl text-gray-800">Dion√≠sio</div>
                    <div class="flex gap-2">
                        <div id="displayRarityBadge" class="text-[10px] px-3 py-1 rounded-full font-black mt-1 text-white uppercase bg-gray-400">COMUM</div>
                        <div id="displayEffectBadge" class="text-[10px] px-3 py-1 rounded-full font-black mt-1 text-white uppercase bg-blue-400 hidden">EFEITO</div>
                    </div>
                    <div id="displayMult" class="text-xs text-yellow-600 font-bold mt-2 bg-yellow-100 px-3 py-1 rounded-full">x1 Moedas</div>
                </div>

                <div class="grid gap-2 w-full">
                    <button class="btn bg-orange-500 shadow-orange-200" onclick="game.startGame()"><i class="fas fa-play mr-2"></i> JOGAR</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="btn bg-blue-500" onclick="game.openUI('shop')"><i class="fas fa-store mr-1"></i> LOJA</button>
                        <button class="btn bg-purple-500" onclick="game.openUI('collection')"><i class="fas fa-paw mr-1"></i> GATIL</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <button class="btn bg-yellow-500" onclick="game.openUI('leaderboard')"><i class="fas fa-trophy mr-1"></i> RANK</button>
                         <button class="btn bg-cyan-500" onclick="game.openUI('friends')"><i class="fas fa-user-friends mr-1"></i> AMIGOS</button>
                    </div>
                    <button class="btn bg-indigo-600" onclick="game.openUI('tournaments')"><i class="fas fa-medal mr-1"></i> TORNEIOS</button>
                    <button class="btn bg-teal-500" onclick="game.openUI('news')"><i class="fas fa-newspaper mr-1"></i> NEWS</button>
                    <button class="btn bg-pink-500" onclick="game.openUI('market')"><i class="fas fa-hand-holding-usd mr-1"></i> MERCADO</button>
                </div>
                <button id="logoutBtn" class="hidden text-[10px] bg-red-100 text-red-500 px-3 py-1 rounded-full font-bold mt-2" onclick="authSystem.logout()">SAIR DA CONTA</button>
            </div>
        </div>

        <div id="marketScreen" class="ui-layer interactive hidden">
             <div class="card h-[85vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-pink-600"><i class="fas fa-hand-holding-usd"></i> MERCADO</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <button class="flex-1 btn bg-pink-500 text-xs py-2 mb-0" onclick="market.showBuy()">COMPRAR</button>
                    <button class="flex-1 btn bg-gray-500 text-xs py-2 mb-0" onclick="market.showSell()">VENDER</button>
                </div>

                <div id="marketBuyPanel" class="flex-1 flex flex-col overflow-hidden">
                    <div id="marketList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar">
                        <div class="text-center text-gray-400 mt-10">Carregando ofertas...</div>
                    </div>
                </div>

                <div id="marketSellPanel" class="flex-1 flex flex-col overflow-hidden hidden">
                    <div class="bg-gray-100 p-4 rounded-xl mb-4 text-left">
                         <label class="text-xs font-bold text-gray-500 block mb-1">QUAL GATO VENDER?</label>
                         <select id="sellCatSelect" class="w-full p-2 rounded mb-3 text-sm font-bold bg-white"></select>
                         
                         <label class="text-xs font-bold text-gray-500 block mb-1">QUANTIDADE</label>
                         <input type="number" id="sellQty" value="1" min="1" class="w-full p-2 rounded mb-3 text-sm font-bold bg-white">
                         
                         <label class="text-xs font-bold text-gray-500 block mb-1">PRE√áO EM MOEDAS</label>
                         <input type="number" id="sellPrice" placeholder="Valor" class="w-full p-2 rounded mb-4 text-sm font-bold bg-white">
                         
                         <button class="btn bg-green-500 mb-0" onclick="market.createListing()">CRIAR AN√öNCIO (24h)</button>
                    </div>
                    <div class="text-[10px] text-gray-400">Voc√™ s√≥ pode ter 3 an√∫ncios ativos.</div>
                    <div id="myListings" class="overflow-y-auto flex-1 mt-2 pr-2 custom-scrollbar"></div>
                </div>
             </div>
        </div>

        <div id="codesScreen" class="ui-layer interactive hidden">
             <div class="card">
                <h2 class="text-2xl font-black text-green-600 mb-2"><i class="fas fa-gift"></i> RESGATAR</h2>
                <p class="text-xs text-gray-500 mb-4">Insira um c√≥digo promocional para ganhar recompensas.</p>
                <input type="text" id="codeInput" placeholder="C√ìDIGO" class="w-full bg-gray-100 p-3 rounded-xl mb-4 font-bold text-center uppercase">
                <button class="btn bg-green-500" onclick="game.redeemCode()">RESGATAR</button>
                <button class="btn bg-gray-500" onclick="game.openUI('menu')">VOLTAR</button>
             </div>
        </div>

        <div id="notificationsScreen" class="ui-layer interactive hidden">
            <div class="card h-[70vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-gray-800">NOTIFICA√á√ïES</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                <div id="notifList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar"></div>
            </div>
        </div>
        
        <div id="tournamentsScreen" class="ui-layer interactive hidden">
             <div class="card h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-indigo-600"><i class="fas fa-medal"></i> TORNEIOS</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                <div id="tournamentList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar"></div>
             </div>
        </div>

        <div id="shopScreen" class="ui-layer interactive hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-gray-800">LOJA</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>

                <div class="bg-yellow-100 text-yellow-800 p-2 rounded-xl mb-4 font-black flex justify-between px-4 items-center">
                    <span class="text-xs opacity-70">SALDO</span> 
                    <span class="text-xl"><i class="fas fa-coins"></i> <span id="shopBalance">0</span></span>
                </div>

                <div class="bg-gray-50 border-2 border-gray-200 p-2 rounded-xl mb-4 text-left">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-black text-gray-700 text-sm flex items-center">
                            <i class="fas fa-calendar-day mr-1 text-blue-500"></i> OFERTAS GLOBAIS
                            <span id="dailyTimer" class="daily-timer">...</span>
                        </h3>
                    </div>
                    <div id="dailyShopList" class="flex gap-2 justify-center">
                         <div class="text-xs text-gray-400">Carregando servidor...</div>
                    </div>
                </div>

                <h3 class="font-black text-gray-400 text-xs text-left mb-1 ml-1 uppercase">Caixas Misteriosas</h3>
                <div id="boxesContainer" class="flex flex-col gap-2 overflow-y-auto pr-1 flex-1 h-[200px] custom-scrollbar"></div>
            </div>
        </div>

        <div id="friendsScreen" class="ui-layer interactive hidden">
            <div class="card h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-cyan-600"><i class="fas fa-user-friends"></i> AMIGOS</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                
                <div class="bg-white p-2 rounded-xl border border-gray-200 mb-4">
                    <input type="text" id="friendSearchInput" placeholder="Pesquisar Nome Exato" class="w-full bg-gray-100 p-2 rounded-lg text-xs font-bold mb-2 text-center uppercase">
                    <button class="btn bg-cyan-500 text-xs py-2 mb-0" onclick="searchFriend()">ADICIONAR</button>
                    <div id="friendMsg" class="text-[10px] text-gray-400 mt-1 h-3"></div>
                </div>

                <div id="friendsList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar">
                    <div class="text-gray-400 text-sm text-center mt-10">Voc√™ ainda n√£o tem amigos.</div>
                </div>
            </div>
        </div>

        <div id="newsScreen" class="ui-layer interactive hidden">
            <div class="card h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-teal-600"><i class="fas fa-newspaper"></i> NOT√çCIAS</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                <div id="newsList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar"></div>
            </div>
        </div>

        <div id="collectionScreen" class="ui-layer interactive hidden">
            <div class="card h-[80vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-gray-800">GATIL</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                <div id="collectionList" class="overflow-y-auto flex-1 text-left pr-2 custom-scrollbar"></div>
            </div>
        </div>

        <div id="leaderboardScreen" class="ui-layer interactive hidden">
            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-yellow-600"><i class="fas fa-trophy"></i> TOP MUNDIAL</h2>
                    <button onclick="game.openUI('menu')" class="w-8 h-8 bg-gray-100 rounded-full font-bold">X</button>
                </div>
                <p class="text-[10px] text-gray-400 mb-2">Toque em um jogador para adicionar</p>
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden text-left mb-4 flex-1 overflow-y-auto h-[300px] custom-scrollbar">
                    <div class="bg-gray-100 p-2 text-xs font-bold text-gray-500 flex justify-between sticky top-0">
                        <span>JOGADOR</span> <span>RECORD</span>
                    </div>
                    <div id="leaderboardList">
                         <div class="p-4 text-center text-gray-400 text-sm">Carregando ranking...</div>
                    </div>
                </div>
                <div class="leaderboard-row text-blue-600 bg-blue-50 border-t-2 border-blue-100 p-2 rounded-lg">
                    <span>SEU RECORD</span> <span id="myHighScoreRank">0</span>
                </div>
                <button class="btn bg-gray-500 mt-2" onclick="game.openUI('menu')">VOLTAR</button>
            </div>
        </div>

        <div id="gachaScreen" class="ui-layer interactive hidden bg-black/95 z-[100]">
            <div id="boxAnim" class="text-9xl animate-bounce filter drop-shadow-[0_0_50px_rgba(255,255,0,0.5)]">üì¶</div>
            <div id="gachaResult" class="hidden flex flex-col items-center w-full">
                <div class="card">
                    <div id="gachaNewLabel" class="text-green-500 font-black tracking-widest animate-pulse mb-4 text-xl">NOVO!</div>
                    <div id="gachaDupLabel" class="hidden text-yellow-500 font-black tracking-widest mb-4 text-xl">REPETIDO (ACUMULOU!)</div>
                    <div class="bg-gray-100 rounded-full p-6 mb-4">
                        <canvas id="gachaPreview" width="120" height="120"></canvas>
                    </div>
                   <div id="gachaName" class="text-3xl font-black text-gray-800">Nome</div>
                    <div id="gachaRarity" class="px-6 py-2 rounded-full text-white font-bold my-3 text-sm tracking-wide shadow-md">RARIDADE</div>
                    <button class="btn bg-orange-500 mt-4" onclick="game.openUI('menu')">CONTINUAR</button>
                </div>
            </div>
        </div>

        <div id="gameOverScreen" class="ui-layer interactive hidden">
            <div class="card">
                <h2 class="text-5xl font-black text-red-500 mb-6 drop-shadow-sm">FIM DE JOGO!</h2>
                <div id="tourneyResultMsg" class="hidden text-purple-600 font-bold mb-2">PONTOS DE TORNEIO COMPUTADOS!</div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-gray-50 p-5 rounded-3xl border-2 border-gray-100">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Placar</p>
                        <p id="finalScore" class="text-5xl font-black text-gray-800">0</p>
                    </div>
                    <div class="bg-yellow-50 p-5 rounded-3xl border-2 border-yellow-100">
                        <p class="text-xs font-bold text-yellow-600 uppercase tracking-wide">Moedas</p>
                        <p id="finalCoins" class="text-5xl font-black text-yellow-500">0</p>
                    </div>
                </div>
                <button class="btn bg-orange-500 text-xl mb-3" onclick="game.startGame()">TENTAR DE NOVO</button>
                <button class="btn bg-gray-500" onclick="game.openUI('menu')">MENU</button>
            </div>
        </div>
    </div>

<script>
(function() {
    const CODIGOS_PROMOCIONAIS = [
        { codigo: "SIXSEVEN", tipo: "moedas", valor: 500 },
    ];
    const TOURNAMENT_CONFIG = [
        {
            id: 'copa inicio',
            nome: 'copa inicio',
            inicio: new Date('2026-04-01T00:00:00').getTime(),
            fim: new Date('2026-05-01T00:00:00').getTime(),
            rodadas: 10,
            premio: '5000' 
        }
    ];
    const SONS = {
        musica_menu: 'https://assets.mixkit.co/music/preview/mixkit-games-worldbeat-466.mp3', 
        musica_jogo: '',
        pulo: 'https://assets.mixkit.co/sfx/preview/mixkit-quick-jump-arcade-game-239.wav', 
        score: 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.wav',
        gameover: 'https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.wav',
        click: 'https://assets.mixkit.co/sfx/preview/mixkit-modern-technology-select-3124.wav'
    };
    const MEUS_GATOS = [
        { id: 'g001', nome: 'Dion√≠sio', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/Gemini_Generated_Image_uy5y2puy5y2puy5y%20(1).png', cor_padrao: '#FF9933', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
        { id: 'g002', nome: 'Gato Emo', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/Gemini_Generated_Image_oi2dkjoi2dkjoi2d%20(2).png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
        { id: 'g003', nome: 'Android Neko', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/WhatsApp%20Image%202026-01-03%20at%2001.36.43.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g004', nome: 'Persa', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163730730.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g005', nome: 'Siam√™s', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163712740.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g006', nome: 'Sphynx', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163653076.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g007', nome: 'Gato Laranjinha', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/gato-laranja-filhote.webp', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g008', nome: 'Chocolate', raridade: 'comum', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/37lea95r4h161%20(1).webp', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g009', nome: 'Stray', raridade: 'raro', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/stray-review_7wxr.jpg', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g010', nome: 'Gato de Botas', raridade: 'epico', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/AAT001-P001-89335-1-m-Divulgacao_1.jpg', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g011', nome: 'Tom', raridade: 'epico', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163603209.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g012', nome: 'Garfield', raridade: 'raro', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/images.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: true },
	{ id: 'g013', nome: 'Gato Makonha', raridade: 'mitico', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163513345.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g014', nome: 'Gato Confuso', raridade: 'legendario', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163836118.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g015', nome: 'Skinwalker', raridade: 'secreta', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_163924483.png', cor_padrao: '#FF9923', multiplicador: 1, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g016', nome: 'Bianca', raridade: 'secreta', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_175752638.png', cor_padrao: '#FF9923', multiplicador: 2, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g017', nome: 'Gato em p√©', raridade: 'legendario', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_180044488.png', cor_padrao: '#FF9923', multiplicador: 3, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g018', nome: 'gato de schr√∂dinger morto', raridade: 'secreta', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_180259424.png', cor_padrao: '#FF9923', multiplicador: 5, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g019', nome: 'gato de schr√∂dinger vivo', raridade: 'secreta', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_180327109.png', cor_padrao: '#FF9923', multiplicador: 5, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
	{ id: 'g020', nome: 'victor xavier', raridade: '', imagem: 'https://uploads.onecompiler.io/43nbuw62r/449fq92k6/imagem_2026-01-03_180439637.png', cor_padrao: '#FF9923', multiplicador: 10, efeito: 'nenhum', escala_imagem: 1.3, aparecer_na_loja: false },
    ];
    window.GAME_CATS = MEUS_GATOS;
    
    const NOTICIAS = [
        { data: "03/01/2026", titulo: "MERCADO ABERTO!", texto: "Venda seus gatos repetidos por moedas!" },
        { data: "03/01/2026", titulo: "BUGS CORRIGIDOS", texto: "Canos espa√ßados e lista de amigos consertada." }
    ];
    
    // PRE√áOS
    const CAIXAS_LOJA = [
        { nome: "CAIXA COMUM", raridade: "comum", preco: 20, cor_btn: "bg-gray-400", icone: "üì¶" },
	{ nome: "CAIXA RARA", raridade: "raro", preco: 50, cor_btn: "bg-blue-500", icone: "üì´" },
	{ nome: "CAIXA √âPICA", raridade: "epico", preco: 125, cor_btn: "bg-purple-600", icone: "üéÅ" },
	{ nome: "CAIXA LEND√ÅRIA", raridade: "legendario", preco: 350, cor_btn: "bg-yellow-500", icone: "üëë" },
        { nome: "CAIXA M√çTICA", raridade: "mitico", preco: 750, cor_btn: "bg-red-500", icone: "üîÆ" },
	{ nome: "CAIXA SECRETA", raridade: "secreta", preco: 2000, cor_btn: "bg-gray-900 border-green-500 border", icone: "üåà" }
    ];
    
    const RARITIES = {
        comum: { label: 'Comum', color: '#9CA3AF' },
        raro: { label: 'Raro', color: '#3B82F6' },
        epico: { label: '√âpico', color: '#A855F7' },
        legendario: { label: 'Lend√°rio', color: '#EAB308' },
        mitico: { label: 'M√≠tico', color: '#EF4444' },
        secreta: { label: 'Secreto', color: '#10B981' }
    };
    
    // Image Loader Safe
    MEUS_GATOS.forEach(cat => {
        if(cat.imagem && cat.imagem.length > 5) {
            const img = new Image(); 
            img.src = cat.imagem; 
            img.onerror = () => { cat.imgObj = null; }; // Fallback se erro
            cat.imgObj = img;
        }
    });

    const audioCtx = {
        muted: false,
        play: (key) => {
            if(audioCtx.muted || !SONS[key]) return;
            const a = new Audio(SONS[key]);
            a.volume = 0.5;
            a.play().catch(e => {});
        },
        toggle: () => {
            audioCtx.muted = !audioCtx.muted;
            const icon = document.getElementById('muteIcon');
            if(audioCtx.muted) {
                icon.className = 'fas fa-volume-mute text-red-500';
            } else {
                icon.className = 'fas fa-volume-up text-gray-700';
            }
        }
    };

    // =========================================================================
    // ‚öôÔ∏è SISTEMA DE SAVE
    // =========================================================================
    const SAVE_KEY = 'gb_custom_v6';
    let state = { 
        coins: 0, 
        unlocked: ['g001'], 
        equipped: 'g001', 
        highScore: 0, 
        counts: {'g001':1}, 
        friends: [],
        tournaments: {},
        redeemedCodes: [],
        joinedTournaments: [] 
    };
    window.gameGetState = () => state;
    window.gameSetState = (newData) => {
        state = { ...state, ...newData };
        // Default values ensure no undefined errors
        if(!state.counts) { state.counts = {}; state.unlocked.forEach(id => state.counts[id]=1); }
        if(!state.friends) state.friends = [];
        if(!state.tournaments) state.tournaments = {};
        if(!state.redeemedCodes) state.redeemedCodes = [];
        if(!state.joinedTournaments) state.joinedTournaments = [];
        updateUI();
    };
    window.gameLoadLocal = () => {
        try {
            const saved = localStorage.getItem(SAVE_KEY);
            if(saved) {
                state = {...state, ...JSON.parse(saved)};
                if(!state.counts) { state.counts = {}; state.unlocked.forEach(id => state.counts[id]=1); }
                if(!state.friends) state.friends = [];
                if(!state.tournaments) state.tournaments = {};
                if(!state.redeemedCodes) state.redeemedCodes = [];
                if(!state.joinedTournaments) state.joinedTournaments = [];
                updateUI();
            }
        } catch(e) { console.log("Erro save local"); }
    };
    const save = () => {
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        if(window.authSystem && window.authSystem.saveData) {
            window.authSystem.saveData(state);
        }
        updateUI();
    };

    let dailyShopItems = [];
    let dailyShopExpires = 0;
    window.updateShopFromData = (shopData) => {
        if(!shopData) {
            updateDailyShopLocal();
            return;
        }
        dailyShopItems = shopData.items;
        dailyShopExpires = shopData.expires;
        renderDailyShop();
    };
    function updateDailyShopLocal() {
        const now = Date.now();
        const savedShop = JSON.parse(localStorage.getItem('gb_daily_shop_v3'));
        if (!savedShop || now > savedShop.expires) {
            const pool = MEUS_GATOS.filter(c => ['comum','raro','epico','legendario'].includes(c.raridade));
            const selected = [];
            if (pool.length > 0) {
                for(let i=0; i<3; i++) selected.push(pool[Math.floor(Math.random() * pool.length)].id);
            }
            const newShop = { items: selected, expires: now + 86400000 };
            localStorage.setItem('gb_daily_shop_v3', JSON.stringify(newShop));
            dailyShopItems = newShop.items;
            dailyShopExpires = newShop.expires;
        } else { 
            dailyShopItems = savedShop.items;
            dailyShopExpires = savedShop.expires;
        }
        renderDailyShop();
    }

    function renderDailyShop() {
        const container = document.getElementById('dailyShopList');
        if(!container) return;
        container.innerHTML = '';
        if(!dailyShopItems || dailyShopItems.length === 0) {
             container.innerHTML = '<div class="text-xs text-gray-400 p-2">Loja vazia ou carregando...</div>';
             return;
        }
        dailyShopItems.forEach(id => {
            const cat = MEUS_GATOS.find(c => c.id === id);
            if(!cat) return;
            const owned = state.unlocked.includes(id);
            const div = document.createElement('div');
            div.className = `flex flex-col items-center bg-white p-2 rounded border ${owned ? 'border-green-300 opacity-50' : 'border-gray-300'}`;
            
            const cvs = document.createElement('canvas');
            cvs.width=40; cvs.height=40;
            drawCat(cvs.getContext('2d'), cat, 20, 20, 30, 0);
            
            let price = 50;
            if(cat.raridade === 'raro') price = 150;
            if(cat.raridade === 'epico') price = 300;
            if(cat.raridade === 'legendario') price = 800;

            div.appendChild(cvs);
            div.innerHTML += `<div class="text-[9px] font-bold mt-1">${cat.nome}</div>`;
            
            const btn = document.createElement('button');
            btn.className = `text-[9px] px-2 py-1 rounded mt-1 text-white font-bold ${owned ? 'bg-green-500' : 'bg-blue-500'}`;
            btn.innerText = owned ? `TEM (x${state.counts[id]||1})` : `${price} üí∞`;
            btn.onclick = () => {
                if(Math.floor(state.coins) >= price) {
                    state.coins -= price;
                    if(!state.unlocked.includes(id)) state.unlocked.push(id);
                    state.counts[id] = (state.counts[id] || 0) + 1;
                    
                    save();
                    renderDailyShop(); 
                    audioCtx.play('click');
                    alert(`Comprou ${cat.nome}!`);
                } else { alert('Moedas insuficientes!');
                }
            };
            div.appendChild(btn);
            container.appendChild(div);
        });
    }

    setInterval(() => {
        if(dailyShopExpires > 0) {
            const timerEl = document.getElementById('dailyTimer');
            if(!timerEl) return;
            const diff = dailyShopExpires - Date.now();
            if(diff > 0) {
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                timerEl.innerText = `${h}h ${m}m ${s}s`;
            } else { 
                timerEl.innerText = "Renovando...";
                if(window.syncServerShop) window.syncServerShop();
            }
        }
    }, 1000);

    function drawCat(ctx, cat, x, y, size, frame) {
        if(!cat) return;
        ctx.save();
        ctx.translate(x, y);
        if(cat.efeito === 'brilho' || cat.efeito === 'fogo' || cat.raridade === 'mitico') {
            ctx.shadowBlur = 15 + Math.sin(frame/10)*5;
            ctx.shadowColor = RARITIES[cat.raridade]?.color || 'gold';
            ctx.beginPath(); ctx.arc(0, 0, size/2 + 2, 0, Math.PI*2);
            ctx.fillStyle = RARITIES[cat.raridade]?.color || 'gold';
            ctx.globalAlpha = 0.3; ctx.fill(); ctx.globalAlpha = 1.0;
        }

        let drawSize = size * (cat.escala_imagem || 1.3);
        if (cat.imgObj && cat.imgObj.complete && cat.imgObj.naturalWidth !== 0) {
            ctx.beginPath();
            ctx.arc(0, 0, size/2, 0, Math.PI*2); ctx.clip();
            ctx.drawImage(cat.imgObj, -drawSize/2, -drawSize/2, drawSize, drawSize);
        } else {
            // Fallback colorido se imagem falhar
            ctx.fillStyle = cat.cor_padrao || '#999';
            ctx.beginPath();
            ctx.arc(0, 0, size/2, 0, Math.PI*2); ctx.fill();
            // Orelhas
            ctx.beginPath();
            ctx.moveTo(-size*0.3, -size*0.3); ctx.lineTo(-size*0.4, -size*0.6); ctx.lineTo(-size*0.1, -size*0.4); ctx.fill();
            ctx.beginPath(); ctx.moveTo(size*0.3, -size*0.3); ctx.lineTo(size*0.4, -size*0.6);
            ctx.lineTo(size*0.1, -size*0.4); ctx.fill();
        }
        ctx.restore();
    }

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let frames=0, score=0, playing=false, trail=[];
    let speed=3.0, gravity=0.25;
    let activeTournament = null; 

    let clouds = [];
    for(let i=0; i<5; i++) {
        clouds.push({x: Math.random()*window.innerWidth, y: Math.random()*200, s: 0.5+Math.random()});
    }
    
    function drawBackground() {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        clouds.forEach(c => {
            c.x -= 0.5 * c.s;
            if(c.x < -100) c.x = canvas.width + 100;
            ctx.beginPath();
            ctx.arc(c.x, c.y, 30*c.s, 0, Math.PI*2);
            ctx.arc(c.x+20*c.s, c.y-10*c.s, 40*c.s, 0, Math.PI*2);
            ctx.arc(c.x+40*c.s, c.y, 30*c.s, 0, Math.PI*2);
            ctx.fill();
        });
        ctx.fillStyle = '#1e5f74';
        ctx.beginPath();
        ctx.moveTo(0, canvas.height);
        for(let i=0; i<=canvas.width; i+=50) {
            ctx.lineTo(i, canvas.height - 100 - Math.sin((i + frames)*0.01)*20);
        }
        ctx.lineTo(canvas.width, canvas.height);
        ctx.fill();
    }

    const bird = {
        x: 60, y: 150, v: 0,
        update: function() {
            this.v += gravity;
            this.y += this.v;
            if(this.y + 15 > canvas.height) gameOver();
            if(this.y < 0) this.y = 0;
            const cat = MEUS_GATOS.find(c => c.id === state.equipped);
            if(cat && (cat.efeito === 'rastro' || cat.efeito === 'arco_iris' || cat.efeito === 'fogo')) {
                trail.push({x: this.x, y: this.y, age: 0});
                if(trail.length > 20) trail.shift();
            }
        },
        draw: function() {
            const cat = MEUS_GATOS.find(c => c.id === state.equipped) || MEUS_GATOS[0];
            trail.forEach((t, i) => {
                t.age++;
                let opacity = i / trail.length;
                let size = 20 * opacity;
                if(cat.efeito === 'arco_iris') {
                    const cols = ['#f00','#fa0','#ff0','#0f0','#09f','#50f'];
                    ctx.fillStyle = cols[i%6];
                    ctx.fillRect(t.x-20+(i*2), t.y-10, 6, 20);
                } else {
                    ctx.fillStyle = `rgba(255,255,255,${opacity})`;
                    ctx.beginPath(); ctx.arc(t.x, t.y, size/2, 0, Math.PI*2); ctx.fill();
                }
            });
            drawCat(ctx, cat, this.x, this.y, 55, frames);
        },
        jump: function() { 
            this.v = -6;
            audioCtx.play('pulo');
        }
    };

    const pipes = {
        list: [],
        update: function() {
            let diffMult = 1 + (score * 0.05);
            if(diffMult > 2.5) diffMult = 2.5; 
            let currentSpeed = speed * diffMult;
            
            // Dist√¢ncia 320, Abertura 190 (Conforme pedido)
            // Fix: Check list length first
            if (this.list.length === 0 || (canvas.width - this.list[this.list.length-1].x >= 320)) {
                let gap = 190;
                let padding = 80;
                let minPipe = padding;
                let maxPipe = canvas.height - padding - gap;
                let y = Math.floor(Math.random() * (maxPipe - minPipe + 1)) + minPipe;
                this.list.push({x: canvas.width, y, gap, scored: false});
            }

            for (let i = 0; i < this.list.length; i++) {
                let p = this.list[i];
                p.x -= currentSpeed;
                
                // Colis√£o
                if(bird.x + 20 > p.x && bird.x - 20 < p.x + 60) {
                    if(bird.y - 20 < p.y || bird.y + 20 > p.y + p.gap) gameOver();
                }
                
                // Pontua√ß√£o
                if(p.x + 60 < bird.x && !p.scored) {
                    p.scored = true;
                    score++;
                    audioCtx.play('score');
                    const cat = MEUS_GATOS.find(c => c.id === state.equipped);
                    state.coins += (cat ? cat.multiplicador : 1);
                    document.getElementById('scoreDisplay').innerText = score;
                }
            }
            
            if(this.list.length > 0 && this.list[0].x < -100) this.list.shift();
        },
        draw: function() {
            this.list.forEach(p => {
                let grad = ctx.createLinearGradient(p.x, 0, p.x + 60, 0);
                grad.addColorStop(0, '#4ade80'); 
                grad.addColorStop(0.5, '#22c55e'); 
                grad.addColorStop(1, '#14532d'); 
                ctx.fillStyle = grad;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.fillRect(p.x, 0, 60, p.y);
                ctx.strokeRect(p.x, -2, 60, p.y+2);
                ctx.fillRect(p.x-4, p.y-25, 68, 25);
                ctx.strokeRect(p.x-4, p.y-25, 68, 25);
                let by = p.y + p.gap;
                ctx.fillRect(p.x, by, 60, canvas.height-by);
                ctx.strokeRect(p.x, by, 60, canvas.height-by);
                ctx.fillRect(p.x-4, by, 68, 25);
                ctx.strokeRect(p.x-4, by, 68, 25);
            });
        }
    };

    function loop() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawBackground();
        if(playing) { bird.update(); pipes.update(); frames++; }
        pipes.draw();
        bird.draw();
        
        const menuScreen = document.getElementById('menuScreen');
        if(!playing && menuScreen && !menuScreen.classList.contains('hidden')) {
            const mCtx = document.getElementById('menuPreview').getContext('2d');
            mCtx.clearRect(0,0,100,100);
            drawCat(mCtx, MEUS_GATOS.find(c => c.id === state.equipped), 50, 50, 70, frames);
        }
        requestAnimationFrame(loop);
    }
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    loop();

    function gameOver() {
        playing = false;
        audioCtx.play('gameover');
        if(score > state.highScore) state.highScore = score;
        if(activeTournament && state.joinedTournaments.includes(activeTournament)) {
            const tData = state.tournaments[activeTournament] || { roundsPlayed: 0, totalScore: 0, bestScore: 0 };
            tData.roundsPlayed++;
            tData.totalScore += score;
            if(score > tData.bestScore) tData.bestScore = score;
            state.tournaments[activeTournament] = tData;
            
            document.getElementById('tourneyResultMsg').classList.remove('hidden');
            document.getElementById('tourneyResultMsg').innerText = `RODADA TORNEIO: ${tData.roundsPlayed}`;
        } else {
            document.getElementById('tourneyResultMsg').classList.add('hidden');
        }
        activeTournament = null;

        save();
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('finalScore').innerText = score;
        document.getElementById('finalCoins').innerText = Math.floor(state.coins);
        document.getElementById('hud').classList.add('hidden');
    }

    // DEFININDO OBJETOS GLOBAIS IMEDIATAMENTE PARA EVITAR ERROS DE "UNDEFINED"
    window.game = {
        startGame: () => {
            const now = Date.now();
            const validTournament = TOURNAMENT_CONFIG.find(t => now >= t.inicio && now <= t.fim);
            
            activeTournament = null;
            document.getElementById('tournamentHud').classList.add('hidden');
            if(validTournament) {
                if(state.joinedTournaments.includes(validTournament.id)) {
                    if(!state.tournaments) state.tournaments = {};
                    const tData = state.tournaments[validTournament.id] || { roundsPlayed: 0 };
                    
                    if(tData.roundsPlayed < validTournament.rodadas) {
                        activeTournament = validTournament.id;
                        document.getElementById('tournamentHud').classList.remove('hidden');
                        document.getElementById('tournamentHud').innerText = `üèÜ TORNEIO: Rodada ${tData.roundsPlayed + 1}/${validTournament.rodadas}`;
                    }
                }
            }

            playing = true;
            score = 0; frames = 0; trail = [];
            bird.x = Math.max(60, canvas.width * 0.2);
            bird.y = canvas.height/2;
            bird.v = 0;
            pipes.list = [];
            document.querySelectorAll('.ui-layer').forEach(l => l.classList.add('hidden'));
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('scoreDisplay').innerText = '0';
            audioCtx.play('click');
        },
        toggleMute: () => audioCtx.toggle(),
        openUI: (name) => {
            audioCtx.play('click');
            document.querySelectorAll('.ui-layer').forEach(l => l.classList.add('hidden'));
            const ui = document.getElementById(name+'Screen');
            if(ui) ui.classList.remove('hidden');
            
            if(name === 'menu') updateUI();
            if(name === 'shop') {
                document.getElementById('shopBalance').innerText = Math.floor(state.coins);
                if(window.syncServerShop) window.syncServerShop();
                renderShopBoxes();
            }
            if(name === 'collection') renderCollection();
            if(name === 'news') renderNews();
            if(name === 'leaderboard') {
                 document.getElementById('myHighScoreRank').innerText = state.highScore;
                 if(window.loadFirebaseLeaderboard) window.loadFirebaseLeaderboard();
            }
            if(name === 'friends') { renderFriends(); }
            if(name === 'tournaments') { renderTournaments(); }
            if(name === 'market') { window.market.load(); }
        },
        buyBox: (tier, cost) => {
            audioCtx.play('click');
            if(Math.floor(state.coins) < cost) return alert("Moedas insuficientes!");
            const pool = MEUS_GATOS.filter(c => c.raridade === tier);
            if(pool.length === 0) return alert("Nenhum gato dessa raridade adicionado no c√≥digo ainda!");
            state.coins -= cost;
            save();

            const win = pool[Math.floor(Math.random()*pool.length)];
            const isNew = !state.unlocked.includes(win.id);
            if(isNew) state.unlocked.push(win.id);
            state.counts[win.id] = (state.counts[win.id] || 0) + 1;
            
            save();

            document.getElementById('shopScreen').classList.add('hidden');
            document.getElementById('gachaScreen').classList.remove('hidden');
            document.getElementById('boxAnim').classList.remove('hidden');
            document.getElementById('gachaResult').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('boxAnim').classList.add('hidden');
                document.getElementById('gachaResult').classList.remove('hidden');
                
                if(isNew) {
                    document.getElementById('gachaNewLabel').classList.remove('hidden');
                    document.getElementById('gachaDupLabel').classList.add('hidden');
                } else {
                    document.getElementById('gachaNewLabel').classList.add('hidden');
                    document.getElementById('gachaDupLabel').classList.remove('hidden');
                }
                
                document.getElementById('gachaName').innerText = win.nome;
                const rarityLabel = document.getElementById('gachaRarity');
                rarityLabel.innerText = RARITIES[win.raridade]?.label || 'Especial';
                rarityLabel.style.backgroundColor = RARITIES[win.raridade]?.color || '#000';
                
                const gCtx = document.getElementById('gachaPreview').getContext('2d');
                gCtx.clearRect(0,0,120,120);
                drawCat(gCtx, win, 60, 60, 90, 0);
            }, 1000);
        },
        acceptFriend: async (uid, name) => {
            if(!auth.currentUser) return;
            // 1. Atualiza Localmente
            if(!state.friends) state.friends = [];
            if(state.friends.some(f => f.uid === uid)) return;
            state.friends.push({uid: uid, name: name});
            save();

            // 2. Tenta atualizar no Banco do OUTRO usu√°rio (Corre√ß√£o de erro de permiss√£o)
            try {
                const { doc, getDoc, updateDoc } = window.firebaseDb;
                const otherUserRef = doc(window.firebaseDb, "users", uid);
                const snap = await getDoc(otherUserRef);
                
                if(snap.exists()) {
                    const data = snap.data();
                    let otherFriends = data.friends || [];
                    const myUid = window.authSystem.user.uid;
                    const myName = window.authSystem.user.displayName;
                    
                    if(!otherFriends.some(f => f.uid === myUid)) {
                        otherFriends.push({uid: myUid, name: myName});
                        await updateDoc(otherUserRef, { friends: otherFriends });
                    }
                }
            } catch(e) { 
                console.warn("N√£o foi poss√≠vel adicionar na lista do amigo (permiss√£o ou erro):", e);
                // Mesmo falhando aqui, j√° salvamos localmente
            }

            alert(`${name} agora √© seu amigo!`);
        },
        
        redeemCode: () => {
             const input = document.getElementById('codeInput');
             const code = input.value.trim().toUpperCase();
             const msg = CODIGOS_PROMOCIONAIS.find(c => c.codigo === code);
             
             if(state.redeemedCodes.includes(code)) return alert("C√≥digo j√° resgatado!");
             if(msg) {
                 if(msg.tipo === 'moedas') {
                     state.coins += msg.valor;
                     alert(`Resgatado! +${msg.valor} Moedas!`);
                 }
                 if(msg.tipo === 'gato') {
                     if(!state.unlocked.includes(msg.valor)) state.unlocked.push(msg.valor);
                     state.counts[msg.valor] = (state.counts[msg.valor] || 0) + 1;
                     alert(`Resgatado! Novo Gato desbloqueado!`);
                 }
                 state.redeemedCodes.push(code);
                 save();
                 input.value = "";
                 document.getElementById('shopBalance').innerText = Math.floor(state.coins);
             } else {
                 alert("C√≥digo inv√°lido!");
             }
        },

        joinTournament: (id) => {
             if(confirm("Deseja entrar no torneio?")) {
                 if(!state.joinedTournaments.includes(id)) {
                     state.joinedTournaments.push(id);
                     save();
                     renderTournaments();
                 }
             }
        },
        leaveTournament: (id) => {
            if(confirm("Sair do torneio? Seu progresso ser√° pausado.")) {
                 state.joinedTournaments = state.joinedTournaments.filter(x => x !== id);
                 save();
                 renderTournaments();
            }
        }
    };
    
    window.market = {
        showBuy: () => {
            document.getElementById('marketBuyPanel').classList.remove('hidden');
            document.getElementById('marketSellPanel').classList.add('hidden');
            window.market.load();
        },
        showSell: () => {
            if(!auth.currentUser) return alert("Logue para usar o mercado.");
            document.getElementById('marketBuyPanel').classList.add('hidden');
            document.getElementById('marketSellPanel').classList.remove('hidden');
            
            const select = document.getElementById('sellCatSelect');
            if(!select) return;
            select.innerHTML = '';
            let totalCats = 0;
            state.unlocked.forEach(id => {
                totalCats += (state.counts[id] || 0);
                if((state.counts[id] || 0) > 0) {
                    const cat = MEUS_GATOS.find(c => c.id === id);
                    if(cat) {
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.text = `${cat.nome} (Voc√™ tem: ${state.counts[id]})`;
                        select.appendChild(opt);
                    }
                }
            });

            if(totalCats <= 1) {
                alert("Voc√™ precisa ter mais de 1 gato no total para vender!");
                window.market.showBuy();
            } else {
                window.market.loadMyListings();
            }
        },
        createListing: async () => {
            const catId = document.getElementById('sellCatSelect').value;
            const qty = parseInt(document.getElementById('sellQty').value);
            const price = parseInt(document.getElementById('sellPrice').value);
            
            if(!catId || qty < 1 || price < 1) return alert("Preencha tudo corretamente.");
            if((state.counts[catId] || 0) < qty) return alert("Voc√™ n√£o tem essa quantidade!");
            
            try {
                const { collection, query, where, getDocs, addDoc } = window.firebaseDb;
                const q = query(collection(window.firebaseDb, "market_listings"), where("sellerId", "==", window.authSystem.user.uid));
                const snap = await getDocs(q);
                if(snap.size >= 3) return alert("Limite de 3 an√∫ncios atingido!");
                
                // Deduz
                state.counts[catId] -= qty;
                if(state.counts[catId] <= 0) {
                    state.unlocked = state.unlocked.filter(i => i !== catId);
                    if(state.equipped === catId) state.equipped = 'g001';
                }
                save();

                await addDoc(collection(window.firebaseDb, "market_listings"), {
                    sellerId: window.authSystem.user.uid,
                    sellerName: window.authSystem.user.displayName,
                    catId: catId,
                    qty: qty,
                    price: price,
                    expires: Date.now() + 86400000 
                });
                alert("An√∫ncio criado!");
                window.market.showSell();
            } catch(e) {
                console.error(e);
                alert("Erro ao criar an√∫ncio (Verifique console).");
            }
        },
        buy: async (listingId, price, catId, qty) => {
            if(state.coins < price) return alert("Moedas insuficientes!");
            
            try {
                const { doc, runTransaction } = window.firebaseDb;
                const listRef = doc(window.firebaseDb, "market_listings", listingId);
                
                await runTransaction(window.firebaseDb, async (transaction) => {
                    const sfDoc = await transaction.get(listRef);
                    if (!sfDoc.exists()) throw "An√∫ncio n√£o existe mais.";
                    
                    const sellerId = sfDoc.data().sellerId;
                    const sellerRef = doc(window.firebaseDb, "users", sellerId);
                    
                    // Transfere o item (L√≥gica Client-Side segura o suficiente pra jogo simples)
                    state.coins -= price;
                    if(!state.unlocked.includes(catId)) state.unlocked.push(catId);
                    state.counts[catId] = (state.counts[catId] || 0) + qty;
                    save();

                    // Paga o vendedor
                    const sellerSnap = await transaction.get(sellerRef);
                    if(sellerSnap.exists()) {
                        const sData = sellerSnap.data();
                        const newCoins = (sData.coins || 0) + price;
                        transaction.update(sellerRef, { coins: newCoins });
                    }
                    
                    transaction.delete(listRef);
                });
                alert("Compra realizada com sucesso!");
                window.market.load();
                document.getElementById('shopBalance').innerText = Math.floor(state.coins);
            } catch (e) {
                console.error(e);
                alert("Erro na transa√ß√£o: " + e);
            }
        },
        load: async () => {
            const list = document.getElementById('marketList');
            if(!list) return;
            list.innerHTML = '<div class="text-center text-gray-400 mt-10"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
            
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firebaseDb;
                const now = Date.now();
                const q = query(collection(window.firebaseDb, "market_listings"), orderBy("expires", "desc"), limit(50));
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 mt-10">Nenhuma oferta no momento.</div>';
                    return;
                }
                
                let count = 0;
                snap.forEach(d => {
                    const data = d.data();
                    if(data.expires < now) return; 
                    if(auth.currentUser && data.sellerId === auth.currentUser.uid) return;

                    const cat = MEUS_GATOS.find(c => c.id === data.catId);
                    if(!cat) return;

                    count++;
                    const el = document.createElement('div');
                    el.className = 'market-item';
                    el.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-gray-100 rounded border border-gray-300 overflow-hidden">
                                 <img src="${cat.imagem}" class="w-full h-full object-cover">
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-sm text-gray-700">${cat.nome} <span class="text-xs text-gray-500">x${data.qty}</span></div>
                                <div class="text-[10px] text-gray-400">Vendedor: ${data.sellerName}</div>
                            </div>
                        </div>
                        <button class="btn bg-green-500 py-2 px-4 text-xs w-auto mb-0" onclick="market.buy('${d.id}', ${data.price}, '${data.catId}', ${data.qty})">
                            ${data.price} üí∞
                        </button>
                    `;
                    list.appendChild(el);
                });
                if(count === 0) list.innerHTML = '<div class="text-center text-gray-400 mt-10">Apenas seus an√∫ncios ativos.</div>';

            } catch(e) {
                console.error("Erro mercado:", e);
                list.innerHTML = '<div class="text-center text-red-400 mt-10">Erro ao carregar mercado.</div>';
            }
        },
        loadMyListings: async () => {
            const list = document.getElementById('myListings');
            if(!list) return;
            list.innerHTML = '...';
            try {
                const { collection, query, where, getDocs, deleteDoc, doc } = window.firebaseDb;
                const q = query(collection(window.firebaseDb, "market_listings"), where("sellerId", "==", window.authSystem.user.uid));
                const snap = await getDocs(q);
                
                list.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const cat = MEUS_GATOS.find(c => c.id === data.catId);
                    if(!cat) return;

                    const el = document.createElement('div');
                    el.className = 'market-item bg-pink-50 border-pink-200';
                    el.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="font-bold text-sm text-gray-700">${cat.nome} x${data.qty}</div>
                            <div class="font-bold text-sm text-yellow-600">${data.price} üí∞</div>
                        </div>
                        <button class="btn bg-red-500 py-1 px-3 text-[10px] w-auto mb-0" id="del-${d.id}">X</button>
                    `;
                    list.appendChild(el);
                    document.getElementById(`del-${d.id}`).onclick = async () => {
                        if(confirm("Cancelar an√∫ncio? Os itens ser√£o perdidos (regras do mercado).")) {
                            await deleteDoc(doc(window.firebaseDb, "market_listings", d.id));
                            window.market.showSell();
                        }
                    }
                });
            } catch(e) { console.error(e); }
        }
    };

    function renderFriends() {
        const list = document.getElementById('friendsList');
        if(!list) return;
        list.innerHTML = '';
        if(!state.friends || state.friends.length === 0) {
            list.innerHTML = '<div class="text-gray-400 text-sm text-center mt-10">Voc√™ ainda n√£o tem amigos.<br>Adicione pelo Rank ou Pesquisa.</div>';
            return;
        }
        
        const { doc, getDoc } = window.firebaseDb;
        state.friends.forEach(async (f) => {
            const div = document.createElement('div');
            div.className = 'friend-row';
            
            let isOnline = false;
            try {
                if(window.firebaseDb) {
                    const snap = await getDoc(doc(window.firebaseDb, "users", f.uid));
                    if(snap.exists()) {
                        const last = snap.data().lastActive || 0;
                        if(Date.now() - last < 5 * 60 * 1000) isOnline = true;
                    }
                }
            } catch(e){}

            div.innerHTML = `
                <div class="flex items-center">
                    <span class="${isOnline ? 'online-dot' : 'offline-dot'}"></span>
                    <span><i class="fas fa-user text-cyan-500 mr-2"></i> ${f.name}</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    function renderTournaments() {
        const list = document.getElementById('tournamentList');
        if(!list) return;
        list.innerHTML = '';
        const now = Date.now();
        
        TOURNAMENT_CONFIG.forEach(t => {
            const isActive = now >= t.inicio && now <= t.fim;
            const userData = state.tournaments ? (state.tournaments[t.id] || {}) : {};
            const roundsPlayed = userData.roundsPlayed || 0;
            const bestScore = userData.bestScore || 0;
            const isJoined = state.joinedTournaments.includes(t.id);
            
            const div = document.createElement('div');
            div.className = `p-4 rounded-xl mb-2 border-2 ${isActive ? 'bg-indigo-50 border-indigo-200' : 'bg-gray-100 border-gray-200 opacity-60'}`;
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-black text-gray-800">${t.nome}</h3>
                    <span class="text-[10px] font-bold px-2 py-1 rounded text-white ${isActive ? 'bg-green-500' : 'bg-gray-500'}">
                        ${isActive ? 'ATIVO' : 'FECHADO'}
                    </span>
                </div>
                <div class="text-xs text-gray-600 mb-2">
                    Rodadas: ${roundsPlayed}/${t.rodadas}<br>
                    Seu Melhor Record: ${bestScore}
                </div>
                <div class="flex gap-2">
                    ${isActive && !isJoined ? `<button class="btn bg-green-500 py-1 text-xs" onclick="game.joinTournament('${t.id}')">PARTICIPAR</button>` : ''}
                    ${isActive && isJoined ? `<button class="btn bg-red-500 py-1 text-xs" onclick="game.leaveTournament('${t.id}')">SAIR</button>` : ''}
                </div>
                ${isJoined ? `<p class="text-[10px] text-indigo-500 font-bold mt-1">Voc√™ est√° participando!</p>` : ''}
            `;
            list.appendChild(div);
        });
    }

    function renderShopBoxes() {
        const container = document.getElementById('boxesContainer');
        if(!container) return;
        container.innerHTML = '';
        CAIXAS_LOJA.forEach(box => {
            const btn = document.createElement('button');
            btn.className = `btn ${box.cor_btn} flex justify-between items-center p-2`;
            btn.onclick = () => game.buyBox(box.raridade, box.preco);
            btn.innerHTML = `
                <div class="flex items-center gap-2"><span class="text-xl">${box.icone}</span> <span class="text-sm uppercase">${box.nome}</span></div> 
                <span>${box.preco} üí∞</span>
            `;
            container.appendChild(btn);
        });
    }

    function renderNews() {
        const container = document.getElementById('newsList');
        if(!container) return;
        container.innerHTML = '';
        if(NOTICIAS.length === 0) {
            container.innerHTML = '<div class="text-gray-400 p-4">Nenhuma not√≠cia no momento.</div>';
            return;
        }
        NOTICIAS.forEach(news => {
            const div = document.createElement('div');
            div.className = 'news-item';
            div.innerHTML = `
                <div class="news-date">${news.data}</div>
                <div class="news-title">${news.titulo}</div>
                <div class="news-body">${news.texto}</div>
            `;
            container.appendChild(div);
        });
    }

    function updateUI() {
        const cat = MEUS_GATOS.find(c => c.id === state.equipped) || MEUS_GATOS[0];
        document.getElementById('displayName').innerText = cat.nome;
        const rInfo = RARITIES[cat.raridade];
        document.getElementById('displayRarityBadge').innerText = rInfo ? rInfo.label : 'COMUM';
        document.getElementById('displayRarityBadge').style.backgroundColor = rInfo ? rInfo.color : '#999';
        
        if(cat.efeito && cat.efeito !== 'nenhum') {
            document.getElementById('displayEffectBadge').classList.remove('hidden');
            document.getElementById('displayEffectBadge').innerText = cat.efeito.toUpperCase();
        } else {
            document.getElementById('displayEffectBadge').classList.add('hidden');
        }
        document.getElementById('displayMult').innerText = `x${cat.multiplicador} Moedas`;
        document.getElementById('coinCountHud').innerText = Math.floor(state.coins);
    }

    function renderCollection() {
        const container = document.getElementById('collectionList');
        if(!container) return;
        container.innerHTML = '';
        const tiers = ['comum','raro','epico','legendario','mitico','secreta'];
        
        tiers.forEach(t => {
            const pool = MEUS_GATOS.filter(c => c.raridade === t);
            if(pool.length === 0) return;
            const unlocked = pool.filter(c => state.unlocked.includes(c.id)).length;
            
            const div = document.createElement('div');
            div.className = 'cat-section-title font-bold text-gray-500 mt-2 mb-1 flex justify-between px-1';
            div.innerHTML = `<span>${RARITIES[t].label}</span> <span>${unlocked}/${pool.length}</span>`;
            container.appendChild(div);

            const grid = document.createElement('div');
            grid.className = 'skin-grid';
            pool.forEach(cat => {
                const owned = state.unlocked.includes(cat.id);
                const count = state.counts[cat.id] || 0;
                
                const item = document.createElement('div');
                item.className = `skin-item ${owned ? '' : 'locked'} ${state.equipped === cat.id ? 'selected' : ''}`;
                const cvs = document.createElement('canvas');
                cvs.width = 40; cvs.height = 40;
                drawCat(cvs.getContext('2d'), cat, 20, 20, 30, 0);
                item.appendChild(cvs);
                if(owned && count > 1) {
                    const badge = document.createElement('div');
                    badge.className = 'count-badge';
                    badge.innerText = `x${count}`;
                    item.appendChild(badge);
                }

                item.onclick = () => {
                    if(owned) { 
                        state.equipped = cat.id;
                        save(); 
                        renderCollection(); 
                        audioCtx.play('click');
                    }
                };
                grid.appendChild(item);
            });
            container.appendChild(grid);
        });
    }

    window.addEventListener('mousedown', e => { if(!e.target.closest('.interactive') && playing) bird.jump(); });
    window.addEventListener('touchstart', e => { if(!e.target.closest('.interactive') && playing) { e.preventDefault(); bird.jump(); } }, {passive:false});
    window.addEventListener('keydown', e => { if(e.code==='Space' && playing) bird.jump(); });

    updateUI();
})();
</script>
</body>
</html>
